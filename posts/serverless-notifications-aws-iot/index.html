<!doctype html><html lang=en>
<head>
<title>Real Time Serverless Notifications with AWS IoT :: Rosack Software Solutions</title>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta name=description content="A big downside of current &amp;ldquo;Serverless&amp;rdquo; architectures is, well, you don&amp;rsquo;t have a server! Because of this, some things that we take for granted in web applications today are hard to do in a Serverless model - take real time notifications for example. Usually you&amp;rsquo;d use SignalR, Socket.IO, or some other framework to help you set up and use websocket connections, but those frameworks require a long-lived connection to a server.">
<meta name=keywords content=",">
<meta name=robots content="noodp">
<link rel=canonical href=https://www.rosacksoftwaresolutions.com/posts/serverless-notifications-aws-iot/>
<link rel=stylesheet href=https://www.rosacksoftwaresolutions.com/assets/style.css>
<link rel=stylesheet href=https://www.rosacksoftwaresolutions.com/assets/blue.css>
<link rel=stylesheet href=https://www.rosacksoftwaresolutions.com/style.css>
<link rel=apple-touch-icon sizes=120x120 href=/apple-touch-icon.png>
<link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png>
<link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png>
<link rel=manifest href=/site.webmanifest>
<link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5>
<meta name=msapplication-TileColor content="#da532c">
<meta name=theme-color content="#ffffff">
<meta name=twitter:card content="summary">
<meta property="og:locale" content="en">
<meta property="og:type" content="article">
<meta property="og:title" content="Real Time Serverless Notifications with AWS IoT">
<meta property="og:description" content="A big downside of current &amp;ldquo;Serverless&amp;rdquo; architectures is, well, you don&amp;rsquo;t have a server! Because of this, some things that we take for granted in web applications today are hard to do in a Serverless model - take real time notifications for example. Usually you&amp;rsquo;d use SignalR, Socket.IO, or some other framework to help you set up and use websocket connections, but those frameworks require a long-lived connection to a server.">
<meta property="og:url" content="https://www.rosacksoftwaresolutions.com/posts/serverless-notifications-aws-iot/">
<meta property="og:site_name" content="Rosack Software Solutions">
<meta property="og:image" content="https://www.rosacksoftwaresolutions.com/img/favicon/blue.png">
<meta property="og:image:width" content="2048">
<meta property="og:image:height" content="1024">
<meta property="article:published_time" content="2017-08-26 11:11:13 +0000 UTC">
</head>
<body class=blue>
<div class="container center headings--one-size">
<header class=header>
<div class=header__inner>
<div class=header__logo>
<a href=https://www.rosacksoftwaresolutions.com>
<div class=logo>
<img src=/img/RSS-logo.png>
</div>
</a>
</div>
<div class=menu-trigger>menu</div>
</div>
<nav class=menu>
<ul class="menu__inner menu__inner--desktop">
<li><a href=/portfolio>Portfolio</a></li>
<li><a href=/posts>Blog</a></li>
<li><a href=/about>About Mike</a></li>
</ul>
<ul class="menu__inner menu__inner--mobile">
<li><a href=/portfolio>Portfolio</a></li>
<li><a href=/posts>Blog</a></li>
<li><a href=/about>About Mike</a></li>
</ul>
</nav>
</header>
<div class=content>
<div class=post>
<h1 class=post-title>
<a href=https://www.rosacksoftwaresolutions.com/posts/serverless-notifications-aws-iot/>Real Time Serverless Notifications with AWS IoT</a></h1>
<div class=post-meta>
<span class=post-date>
2017-08-26
</span>
<span class=post-author>:: Mike Rosack</span>
<span class=post-reading-time>:: 5 min read (882 words)</span>
</div>
<span class=post-tags>
#<a href=https://www.rosacksoftwaresolutions.com/tags/serverless/>serverless</a>&nbsp;
#<a href=https://www.rosacksoftwaresolutions.com/tags/aws/>aws</a>&nbsp;
#<a href=https://www.rosacksoftwaresolutions.com/tags/lambda/>lambda</a>&nbsp;
#<a href=https://www.rosacksoftwaresolutions.com/tags/iot/>iot</a>&nbsp;
#<a href=https://www.rosacksoftwaresolutions.com/tags/pydt/>pydt</a>&nbsp;
</span>
<div class=post-content><div>
<p>A big downside of current &ldquo;Serverless&rdquo; architectures is, well, you don&rsquo;t have a server! Because of this, some things that we take for granted in web applications today are hard to do in a Serverless model - take real time notifications for example. Usually you&rsquo;d use <a href=https://www.asp.net/signalr>SignalR</a>, <a href=https://socket.io/>Socket.IO</a>, or some other framework to help you set up and use websocket connections, but those frameworks require a long-lived connection to a server. You could use a technique like long polling in the serverless model, but serverless options charge by the second, and every second you&rsquo;ve got the connection open doing nothing you&rsquo;re being charged for it. So what to do?</p>
<p>I had this dilemma with <a href=https://www.playyourdamnturn.com/>PYDT&rsquo;s</a> desktop client - it needs to know when a new turn is available for the user to play, but the only way to check for updated turns in a standard serverless model is dumb polling. Unfortunately, the cost of AWS API Gateway (which serves your requests for Lambda) is $4/million requests, so that was going to be way too expensive if we polled once a minute (46K requests a month per user, assuming a user&rsquo;s PC is always on). What I originally ended up doing was caching game state to S3, and polling S3 instead of the API, which is an order of magnitude cheaper (that same $4 gets you about 10 million requests in S3).</p>
<p>That worked fine, but it was hacky, and obviously websockets/push notifications were made for scenarios like this. So what do we do?</p>
<p><a href=https://aws.amazon.com/iot>AWS IoT</a> to the rescue! While it&rsquo;s not really designed for this purpose, it exposes an <a href=http://mqtt.org/>MQTT</a> server that you can use to talk to &ldquo;devices&rdquo; out on the internet, but for our purposes our devices are just going to be normal web browsers. Let&rsquo;s walk through the code I used to get this set up&mldr;</p>
<span class=disclaimer>
<p>DISCLAIMER: The PYDT use case is very simple - no security is required, because no one will care if the messages we&rsquo;re sending (&ldquo;it&rsquo;s your turn&rdquo;) are intercepted by a user that wasn&rsquo;t the intended receiver. Adding security complicates this scenario a lot, but this is a good example of what&rsquo;s possible!</p>
</span>
<p>At it&rsquo;s most basic level, AWS IoT exposes an MQTT endpoint that you can use for pub/sub of messages. There&rsquo;s a lot of other cool functionality in there, but for our purposes that&rsquo;s all we care about. We want each user to only get messages when there&rsquo;s a new turn in one of their games, but nobody else&rsquo;s, so each user will need their own topic to subscribe to. In PYDT, that looks like <strong>/pydt/ENVIRONMENT/user/STEAM_ID/gameupdate</strong>, where ENVIRONMENT is dev or prod, and STEAM_ID is, well, the user&rsquo;s Steam ID.</p>
<h2 id=client-side>Client Side<a href=#client-side class=hanchor arialabel=Anchor>&#8983;</a> </h2>
<p>On the client, we&rsquo;re using <a href=https://github.com/aws/aws-iot-device-sdk-js>aws-iot-device-sdk-js</a>, a library that wraps an MQTT client and adds additional AWS IoT-specific functionality. It&rsquo;s not too hard to set things up, here&rsquo;s all the code it takes (<a href=https://github.com/aws/aws-iot-device-sdk-js>starting at line 114 here</a>):</p>
<div class=collapsable-code>
<input id=174298635 type=checkbox>
<label for=174298635>
<span class=collapsable-code__language>javascript</span>
<span class=collapsable-code__toggle data-label-expand=△ data-label-collapse=▽></span>
</label>
<pre class=language-javascript><code>
  configureIot() {
    const env = PYDT_CONFIG.PROD ? &#39;prod&#39; : &#39;dev&#39;;
    const topic = `/pydt/${env}/user/${this.profile.steamid}/gameupdate`;

    this.iotDevice = awsIot.device({
      region: &#39;us-east-1&#39;,
      protocol: &#39;wss&#39;,
      keepalive: 600,
      accessKeyId: PYDT_CONFIG.IOT_CLIENT_ACCESS_KEY,
      secretKey: PYDT_CONFIG.IOT_CLIENT_SECRET_KEY,
      host: &#39;a21s639tnrshxf.iot.us-east-1.amazonaws.com&#39;
    });

    this.iotDevice.on(&#39;connect&#39;, () =&gt; {
      this.iotDevice.subscribe(topic);
    });

    this.iotDevice.on(&#39;error&#39;, err =&gt; {
      console.log(&#39;IoT error...&#39;, err);
    });

    this.iotDevice.on(&#39;message&#39;, (recTopic, message) =&gt; {
      console.log(&#39;received message from topic &#39;, recTopic);
      if (recTopic === topic) {
        this.loadGames();
      }
    });
  }
</code></pre>
</div>
<p>A couple things to note here:</p>
<ul>
<li>
<p>We set the keepalive to 600 seconds. By default, I think the keepalive is 60, which means the client will ping the server once a minute to make sure the connection is open. AWS doesn&rsquo;t make a big deal out of this in their documentation, but <strong>YOU GET CHARGED FOR EVERY PING</strong>, and at $5/million messages that&rsquo;s even worse than our dumb polling pricing! On a desktop computer, the connection should be fairly stable anyway, so only pinging once every 10 minutes isn&rsquo;t that big of a deal (and I might even make that higher someday).</p>
</li>
<li>
<p>The access and secret keys are set up to only have permissions to subscribe to a topic and receive messages, so a malicious user wouldn&rsquo;t be able to take those keys and publish messages to everyone.</p>
</li>
</ul>
<p>Easy, huh? That&rsquo;s all it takes, and every time the server sends us a message we&rsquo;ll receive it in the message callback!</p>
<h2 id=server-side>Server Side<a href=#server-side class=hanchor arialabel=Anchor>&#8983;</a> </h2>
<p>The server side is even easier, believe it or not. We just use the IotData class in the aws-sdk (<a href=https://github.com/pydt/api/blob/00a352b0b845b8ce097290142d122458c5046817/functions/sns/userTurnNotification.js>see the userTurnNotification handler in the API</a>):</p>
<div class=collapsable-code>
<input id=732458961 type=checkbox>
<label for=732458961>
<span class=collapsable-code__language>javascript</span>
<span class=collapsable-code__toggle data-label-expand=△ data-label-collapse=▽></span>
</label>
<pre class=language-javascript><code>
const iotData = new AWS.IotData({endpoint: &#39;a21s639tnrshxf.iot.us-east-1.amazonaws.com&#39;});

function notifyUserClient(user) {
  return iotData.publish({
    topic: `/pydt/${process.env.SERVERLESS_STAGE}/user/${user.steamId}/gameupdate`,
    payload: &#34;Hello!&#34;,
    qos: 0
  }).promise();
}
</code></pre>
</div>
<p>That&rsquo;s it - all we have to do is point the client at the correct endpoint, and publish a message to the topic for the appropriate user! Notice the qos setting of 0 - that just means fire and forget. If the client is online and ready to receive the message they&rsquo;ll get it, if not, no big deal, just throw the message away.</p>
<h2 id=its-a-bit-anticlimactic>It&rsquo;s a bit anticlimactic&mldr;<a href=#its-a-bit-anticlimactic class=hanchor arialabel=Anchor>&#8983;</a> </h2>
<p>Yeah, that&rsquo;s really all it took to get push notifications working in PYDT! If you do need to authenticate the users you&rsquo;re sending messages to this obviously gets quite a bit more complicated, <a href=https://serverless.com/blog/serverless-notifications-on-aws/>here&rsquo;s a good blog post</a> on serverless.com that describes the extra steps you&rsquo;d need to do. Good luck!</p>
</div></div>
</div>
</div>
<div class=post style=display:grid;grid-template-columns:repeat(auto-fit,minmax(384px,1fr));grid-gap:1rem>
<div>
<h1 class=post-title>Social Links</h1>
<div style=display:flex;justify-content:space-around;margin-bottom:50px>
<a href=https://twitter.com/mike_rosack/ target=_blank><img alt="mike_rosack on twitter" src=/img/twitter.png></a>
<a href=https://www.linkedin.com/in/mrosack/ target=_blank><img alt="mrosack on linked in" src=/img/linkedin.png></a>
<a href=https://github.com/mrosack/ target=_blank><img alt="mrosack on github" src=/img/github.png></a>
</div>
<h1 class=post-title>RSS RSS Feed</h1>
<div style=display:flex;justify-content:space-around;margin-bottom:50px>
<a href=/index.xml><img alt="RSS feed" src=/img/feed.png></a>
</div>
<h1 class=post-title>Email Us!</h1>
<p style=margin-bottom:50px>We'd love to hear from you! <a href=mailto:mike@rosacksoftwaresolutions.com>mike@rosacksoftwaresolutions.com</a></p>
</div>
<div>
<h1 class=post-title><a href=https://twitter.com/mike_rosack>Follow me on Twitter</a></h1>
<a class=twitter-timeline data-height=500 data-theme=dark href="https://twitter.com/mike_rosack?ref_src=twsrc%5Etfw">Tweets by mike_rosack</a> <script async src=https://platform.twitter.com/widgets.js></script>
</div>
</div>
<footer class=footer>
<div class=footer__inner>
<div class=copyright>
<span>© 2021 <a href=mailto:mike@rosacksoftwaresolutions.com>Rosack Software Solutions, LLC</a></span>
<span>:: Powered by <a href=http://gohugo.io>Hugo</a>&nbsp;</span>
<span>:: Theme made by <a href=https://twitter.com/panr>panr</a></span>
</div>
</div>
<p style=text-align:center;font-size:9px>Icons from <a target=_blank href=https://icons8.com>icons8.com</a></p>
</footer>
<script src=https://www.rosacksoftwaresolutions.com/assets/main.js></script>
<script src=https://www.rosacksoftwaresolutions.com/assets/prism.js></script>
</div>
</body>
</html>